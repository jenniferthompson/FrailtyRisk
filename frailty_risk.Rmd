---
title: "Clinical Risk Factors for Long-Term Frailty"
author: "Jennifer Thompson, MPH; Supervisor: Rameela Chandrasekhar, PhD"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_float: yes
    toc_depth: 4
    theme: cosmo
---

Using the BRAIN-ICU and MIND-ICU cohorts, which collected the [CSHA Clinical
Frailty Score](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1188185/) (CFS) both
prior to ICU admission and at three and twelve months following hospital
discharge, we will examine several baseline and in-ICU covariates as potential
risk factors for long-term frailty.

```{r setup}
## Set default options
knitr::opts_chunk$set(echo = TRUE, results = "hide", warning = FALSE, message = FALSE)
options(width = 100)

## Load libraries
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(kableExtra))
suppressPackageStartupMessages(library(rms))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(sparkline))
suppressPackageStartupMessages(library(plotly))
suppressPackageStartupMessages(library(JTHelpers))
suppressPackageStartupMessages(library(captioner))
suppressPackageStartupMessages(library(naniar))
suppressPackageStartupMessages(library(forcats))

## -- kable_styling wrapper to ensure all tables are consistently styled -------
mykablestyle <- function(obj, stripes = FALSE, ...){
  boptions <- c("hover", "responsive", "condensed", "bordered")
  if(stripes){ boptions <- c(boptions, "striped") }
  
  kable_styling(
    obj,
    bootstrap_options = boptions,
    full_width = FALSE,
    ...
  )
}

## -- Function to get predicted values of frailty for every covariate ----------
## Originally used full variable labels, but that's really long for plot titles
## datadist should be set prior to running function
## Both covar and mod_xxx should be *strings* (not the actual model object)
## Must specify at least one of mod_unwtd or mod_wtd, but not necessary to
##  specify both; this will make it easier if we choose to only plot one of the
##  weighted/unweighted models
## varlabels = named char vector; names=variable names, values=labels for plots
## dodge_width = how much to dodge pointrange values
## include_legend: whether to include legend; takes up too much space when
##   plotting everything, but will be useful if we pull out separate plots
predict_cfs_vals <- function(
  covar,
  mod_unwtd = NULL,
  mod_wtd = NULL,
  varlabels,
  dodge_width = 0.5,
  include_legend = FALSE
){
  if(is.null(mod_unwtd) & is.null(mod_wtd)){
    stop(
      "At least one of `mod_unwtd` and `mod_wtd` must be specified",
      call. = FALSE
    )
  }
  if(!(covar %in% names(varlabels))){
    warning("`covar` is not included in `varlabels`", call. = FALSE)
  }

  ## -- Get predicted values for unweighted, weighted models -------------------
  if(!is.null(mod_unwtd)){
    predvals_unwtd <- eval(parse(
      text = sprintf(
        "Predict(%s, %s = NA) %%>%% as.data.frame", mod_unwtd, covar
      )
    ))
    predvals_unwtd$wtd <- 0
  } else{
    predvals_unwtd <- NULL
  }
  
  if(!is.null(mod_wtd)){
    predvals_wtd <- eval(parse(
      text = sprintf(
        "Predict(%s, %s = NA) %%>%% as.data.frame", mod_wtd, covar
      )
    ))
    predvals_wtd$wtd <- 1
  } else{
    predvals_wtd <- NULL
  }
  
  ## Combine predicted values from unweighted, weighted models
  predvals <- bind_rows(predvals_unwtd, predvals_wtd) %>%
    mutate(wtd = factor(wtd, levels = 0:1, labels = c("Unweighted", "IPAW")))
  
  ## -- Plot predicted values --------------------------------------------------
  
  ## Determine whether to 1) use ribbon or pointrange, 2) group by weighted/not
  use_pointrange <- length(unique(predvals[, covar])) < 10
  both_types <- !is.null(mod_unwtd) & !is.null(mod_wtd)
  
  ## Initialize plot
  gg <- ggplot(data = predvals, aes_string(x = covar, y = "yhat")) +
    scale_y_continuous(limits = c(1, 7), breaks = c(1, 3, 5, 7)) +
    theme_minimal() +
    theme(plot.title = element_text(face = "bold", size = 8),
          axis.text = element_text(size = 7),
          panel.border = element_rect(colour = "grey80", fill = NA)) +
    labs(title = varlabels[covar], x = NULL, y = NULL)
  
  ## Add ribbon + line for continuous covariates;
  ## points + CI for categorical (<10 values)
  if(use_pointrange){
    if(!both_types){
      gg <- gg +
        geom_pointrange(
          aes(ymin = lower, ymax = upper), size = 0.2, colour = "#003D79"
        )
    } else{
      gg <- gg +
        geom_pointrange(
          aes(ymin = lower, ymax = upper, colour = wtd),
          position = position_dodge(dodge_width), size = 0.2
        ) +
        scale_colour_manual(name = "", values = c("#003D79", "#790001"))
    }
  } else{
    if(!both_types){
      gg <- gg +
        geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.4, fill = "#003D79") +
        geom_line(colour = "#003D79")
    } else{
      gg <- gg +
        geom_ribbon(aes(ymin = lower, ymax = upper, fill = wtd), alpha = 0.4) +
        geom_line(aes(colour = wtd)) +
        scale_fill_manual(name = "", values = c("#003D79", "#790001")) +
        scale_colour_manual(name = "", values = c("#003D79", "#790001"))
    }
  }
  
  ## Remove legend if needed
  if(!include_legend){
    gg <- gg + theme(legend.position = "none")
  }
  
  gg
}

## Helper function: sum all non-missing values
sum_na <- function(x, ...){ sum(x, na.rm = TRUE, ...) }

## Analysis data sets are stored in a different directory
## This isn't the best way to do this. It's a long story.
if(Sys.info()["sysname"] == "Linux"){
  load("/home/thomps23/ICUDelirium/BRAINMIND/CombineData/brainmind_deid.Rdata")
} else{
  load("/Volumes/thomps23/ICUDelirium/BRAINMIND/CombineData/brainmind_deid.Rdata")
}

## -- Create a site variable based on ID ---------------------------------------
brainmind.oneobs$site <- with(brainmind.oneobs, {
  factor(
    ifelse(id < 12000, 1,
    ifelse(id < 13000, 2,
    ifelse(id < 15000, 3,
    ifelse(id < 16000, 4, 5)))),
    levels = 1:5, labels = c("VUMC", "ST", "TNV", "SLC", "PS")
  )
})

## Indicator for whether patient was MIND-ICU or BRAIN-ICU
brainmind.oneobs$study <- with(brainmind.oneobs, {
  factor(as.numeric(site %in% c("TNV", "SLC", "PS")),
         levels = 0:1, labels = c("BRAIN-ICU", "MIND-ICU"))
})

```

```{r tables_figs}
table_nums <- captioner(prefix = "Table")
table_nums(
  name = "describe_all",
  caption = "Description of All Patients with 3 and/or 12m Frailty Data"
)
table_nums(
  name = "describe_3m",
  caption = "Description of Patients with 3m Frailty Data by 3m CFS"
)
table_nums(
  name = "describe_12m",
  caption = "Description of Patients with 12m Frailty Data by 12m CFS"
)
table_nums(name = "results_3m", caption = "Risk Factors for 3m Frailty")
table_nums(name = "results_12m", caption = "Risk Factors for 12m Frailty")

figure_nums <- captioner(prefix = "Figure")
figure_nums(name = "boxplots_time", caption = "CSHA Frailty Scores Over Time")
figure_nums(name = "boxplots_age", caption = "CSHA Frailty Scores by Age at Enrollment")
figure_nums(name = "spaghetti", caption = "CSHA Frailty Scores Over Time")
figure_nums(
  name = "plots_3m", caption = "Predicted CFS Scores by Risk Factor, 3m"
)
figure_nums(
  name = "plots_12m", caption = "Predicted CFS Scores by Risk Factor, 12m"
)

```

```{r data_prep}
## -- Create age category, dichotomous discharge location variables ------------
brainmind.oneobs <- brainmind.oneobs %>%
  mutate(
    frailty_num = as.numeric(str_sub(frailty, 1, 1)),
    age.cat = factor(ifelse(is.na(age.enroll), NA,
                     ifelse(age.enroll < 50, 1,
                     ifelse(age.enroll < 65, 2, 3))),
                     levels = 1:3, labels = c("<50", "50-64", ">=65")),
    hospdis.home = factor(ifelse(is.na(hospdis.loc), NA,
                          ifelse(hospdis.loc == "Home", 1, 2)),
                          levels = 1:2, labels = c("Home", "Facility")),
    ## Vent LOS is NA for patients who were never on MV;
    ## create new version with 0 for these patients
    vent.los.all.s = ifelse(ever.vent.s == "Never on vent during study period",
                            0,
                            vent.los.tot.s)
  )

## -- Get IDs of those w/ at least partial assessment data at 3 and/or 12m -----
fu_outcomes <- c("rbans.global.score", "rbans.attention.tscore",
                 "rbans.delayedmem.tscore", "rbans.immmemory.tscore",
                 "rbans.language.tscore", "rbans.visuo.tscore",
                 "trail.b.tscore", "trail.a.tscore", "mmse.tscore", "sf36.mcs",
                 "sf36.pcs", "adl.totscore", "faq.totscore", "bdi.totscore",
                 "pcl.totscore", "caps.score", "frailty.fu")

brainmind.fu$any_fu <- rowSums(!is.na(brainmind.fu[, fu_outcomes])) > 0

## -- Create frailty *categories* at 3m, 12m and add to brainmind.oneobs -------
brainmind.fu <- brainmind.fu %>%
  mutate(
    ## Numeric version of frailty for later use
    frailty_num = as.numeric(str_sub(frailty.fu, 1, 1)),
    frailty.cat = factor(
      case_when(
        is.na(frailty_num) ~ as.numeric(NA),
        frailty_num <= 4   ~ 1,
        TRUE               ~ 2
      ),
      levels = 1:2,
      labels = c("Frail (CFS 1-4)", "Not Frail (CFS 5-7)")
    )
  )

fu_frailty <- brainmind.fu %>%
  dplyr::select(id, fu.period, frailty.fu, frailty_num, frailty.cat) %>%
  filter(fu.period %in% c("3 Month", "12 Month")) %>%
  mutate(fu.period = str_extract(fu.period, "^[0-9]+")) %>%
  gather(key = frailty_var, value = frailty_val, frailty.fu:frailty.cat) %>%
  unite(col = "frailty_var", frailty_var, fu.period, sep = ".") %>%
  spread(key = frailty_var, value = frailty_val) %>%
  mutate(frailty_num.3 = as.numeric(frailty_num.3),
         frailty_num.12 = as.numeric(frailty_num.12))

brainmind.oneobs <- merge(brainmind.oneobs, fu_frailty, by = "id", all.x = TRUE)

## -- Abstract number check: How many eligible for asmt at each time point? ----
# ## Want to count all living survivors, even those who withdrew, in denoms
# all_ids <- brainmind.oneobs$id
# out_inhosp <- subset(brainmind.oneobs,
#                      (!is.na(died.inhosp) & died.inhosp == "Died in hospital"))$id
# # |                        (!is.na(studywd) & studywd == "Yes"))$id
# out_3m <- subset(brainmind.fu,
#                  fu.period == "3 Month" &
#                    !is.na(status) &
#                    status %in% c("Deceased"))$id #, "Living-Withdrew from the study"))$id
# in_3m <- setdiff(all_ids, unique(c(out_inhosp, out_3m)))
# 
# out_12m <- subset(brainmind.fu,
#                   fu.period == "12 Month" &
#                     !is.na(status) &
#                     status %in% c("Deceased"))$id #, "Living-Withdrew from the study"))$id
# in_12m <- setdiff(all_ids, unique(c(out_inhosp, out_3m, out_12m)))

## -- For CONSORT info, get in-hospital, f/u status for each patient -----------
brainmind.oneobs <- brainmind.oneobs %>%
  mutate(
    hosp.status = factor(
      case_when(
        ## Patient 14015 withdrew all data, but was not recorded
        id == 14015 |
          (!is.na(studywd.amt) &
           studywd.amt %in% c("2. W/D from Participation and All Data Collected",
                              "4. N/A Study Staff Withdrew Patient")) ~ 1,
        !is.na(died.inhosp) & died.inhosp == "Died in hospital" ~ 2,
        !is.na(studywd) & studywd == "Yes" ~ 3,
        TRUE ~ 4
      ),
      levels = 1:4,
      labels = c("Withdrew all data", "Died in hospital",
                 "Withdrew in hospital", "Discharged alive, remained in study")
    ),
    three.status = factor(
      case_when(
        hosp.status != "Discharged alive, remained in study" ~ as.numeric(NA),
        !is.na(frailty.fu.3) ~ 5,
        !is.na(frailty.fu.12) ~ 4,
        id %in% subset(
          brainmind.fu,
          fu.period == "3 Month" & status == "Deceased"
        )$id ~ 1,
        id %in% subset(
          brainmind.fu,
          fu.period == "3 Month" & status == "Living-Withdrew from the study"
        )$id ~ 2,
        TRUE ~ 3
      ),
      levels = 1:5,
      labels = c("Died before 3m followup",
                 "Withdrew before 3m followup",
                 "Permanently lost to followup",
                 "Temporarily lost to followup",
                 "Assessed at 3m followup")
    ),
    twelve.status = factor(
      case_when(
        hosp.status != "Discharged alive, remained in study" |
          (!is.na(three.status) & three.status %in%
             c("Died before 3m followup", "Withdrew before 3m followup")) ~
             as.numeric(NA),
        !is.na(frailty.fu.12) ~ 4,
        id %in% subset(
          brainmind.fu,
          fu.period == "12 Month" & status == "Deceased"
        )$id ~ 1,
        id %in% subset(
          brainmind.fu,
          fu.period == "12 Month" & status == "Living-Withdrew from the study"
        )$id ~ 2,
        TRUE ~ 3
      ),
      levels = 1:4,
      labels = c("Died before 12m followup",
                 "Withdrew before 12m followup",
                 "Lost to followup",
                 "Assessed at 12m followup")
    )
  )

## -- IDs of patients included at 3m, 12m, either ------------------------------
pts_3m <- brainmind.oneobs %>%
  filter(three.status == "Assessed at 3m followup", !is.na(frailty.fu.3)) %>%
  pull(id)
pts_12m <- brainmind.oneobs %>%
  filter(twelve.status == "Assessed at 12m followup", !is.na(frailty.fu.12)) %>%
  pull(id)
pts_fu <- union(pts_3m, pts_12m)

```

# Patient Flow

For current purposes, "followup" indicates a CSHA Clinical Frailty Score at the
specified time point.

Patients were screened between `r min(brain.first.exc, brain.first.enroll)` and
`r max(c(brain.last.exc, brain.last.enroll, mind.last.exc, mind.last.enroll))`.

```{r prep_consort_table}
## -- In-hospital section ------------------------------------------------------
n_wdall <- sum_na(brainmind.oneobs$hosp.status == "Withdrew all data")
n_eval <- sum_na(brainmind.oneobs$hosp.status != "Withdrew all data")
n_diedinhosp <- sum_na(brainmind.oneobs$hosp.status == "Died in hospital")
n_wdinhosp <- sum_na(brainmind.oneobs$hosp.status == "Withdrew in hospital")
n_dcalive <-
  sum_na(brainmind.oneobs$hosp.status == "Discharged alive, remained in study")

consort_inhosp <- tribble(
  ~ current,                             ~ npts,
  "Enrolled in BRAIN-ICU or MIND-ICU",   nrow(brainmind.oneobs),
  "   Withdrew all data",                n_wdall,
  "   Evaluated in hospital",            n_eval,
  "      Died in hospital",              n_diedinhosp,
  "      Withdrew in hospital",          n_wdinhosp,
  "      Discharged, remained in study", n_dcalive
)

## -- 3m followup section ------------------------------------------------------
n_died3m <- sum_na(brainmind.oneobs$three.status == "Died before 3m followup")
n_wd3m <- sum_na(brainmind.oneobs$three.status == "Withdrew before 3m followup")
n_noassess3m <- sum_na(
  brainmind.oneobs$three.status %in%
    c("Permanently lost to followup", "Temporarily lost to followup")
)
n_lostperm3m <-
  sum_na(brainmind.oneobs$three.status == "Permanently lost to followup")
n_losttemp3m <-
  sum_na(brainmind.oneobs$three.status == "Temporarily lost to followup")
n_fu3m <- sum_na(brainmind.oneobs$three.status == "Assessed at 3m followup")

consort_3m <- tribble(
  ~ current,                            ~ npts,
    "Discharged, remained in study",      n_dcalive,
    "   Died before 3m followup",         n_died3m,
    "   Withdrew before 3m followup",     n_wd3m,
    "   No 3m assessment",                n_noassess3m,
    "      Permanently lost to followup", n_lostperm3m,
    "      Temporarily lost to followup", n_losttemp3m,
    "   3m followup available",           n_fu3m
)

## -- 12m followup section -----------------------------------------------------
n_died12m <- sum_na(brainmind.oneobs$twelve.status == "Died before 12m followup")
n_wd12m <- sum_na(brainmind.oneobs$twelve.status == "Withdrew before 12m followup")
n_noassess12m <- sum_na(brainmind.oneobs$twelve.status == "Lost to followup")
n_fu12m <- sum_na(brainmind.oneobs$twelve.status == "Assessed at 12m followup")

consort_12m <- tribble(
  ~ current,                         ~ npts,
    "Eligible for 12m followup",       n_dcalive - (n_died3m + n_wd3m),
    "   Died before 12m followup",     n_died12m,
    "   Withdrew before 12m followup", n_wd12m,
    "   No 12m assessment",            n_noassess12m,
    "   12m followup available",       n_fu12m
)

consort_info <- bind_rows(consort_inhosp, consort_3m, consort_12m)

```

```{r print_consort_table}
consort_info %>%
  # mutate(
  #    current = cell_spec(
  #     current,
  #     "html",
  #     color = ifelse(str_detect(current, " lost to followup"), "#999999", "black")
  #   )
  # ) %>%
  kable(
    format = "html", col.names = c("", "N"), align = c("l", "r"), escape = FALSE
  ) %>%
  group_rows("Enrolled Patients", 1, 6) %>%
  group_rows("Three-Month Follow-Up", 7, 13) %>%
  group_rows("Twelve-Month Follow-Up", 14, 18) %>%
  row_spec(row = 11:12, italic = TRUE, color = "#999999") %>%
  kable_styling(
    bootstrap_options = "striped", full_width = FALSE, position = "center"
  )

```

# Description of Cohort

We'll describe the cohort in two ways:

1. Baseline and in-hospital characteristics of any patient with at least some
followup assessment data available at 3- and/or 12-month followup
(`r table_nums("describe_all", display = "cite")`)
1. Baseline and in-hospital characteristics *and* CFS of any patient with CFS
available at a) 3 months and b) 12 months (`r table_nums("describe_3m", display = "cite")`
and `r table_nums("describe_12m", display = "cite")`), stratified by CFS at that
time point

```{r describe_tables}
label(brainmind.oneobs$age.enroll) <- "Age at study enrollment"
label(brainmind.oneobs$sex.pp) <- "Sex"
label(brainmind.oneobs$ever.vent.s) <- "Ever on MV during study period"
label(brainmind.oneobs$vent.los.all.s) <- "Days on MV during study period"
label(brainmind.oneobs$ever.sevseptic.s) <- "Ever severely septic during study period"
label(brainmind.oneobs$ever.del.s) <- "Ever delirious during study period"
label(brainmind.oneobs$ever.coma.s) <- "Ever comatose during study period"
label(brainmind.oneobs$hospdis.home) <- "Discharge location (home/other)"
label(brainmind.oneobs$frailty_num) <- "CSHA CFS at enrollment"
label(brainmind.oneobs$frailty) <- "CSHA Frailty Score at enrollment"
label(brainmind.oneobs$frailty.fu.3) <- "CSHA Frailty Score, 3m"
label(brainmind.oneobs$frailty.fu.12) <- "CSHA Frailty Score, 12m"
label(brainmind.oneobs$frailty.cat.3) <- "CFS Category, 3m"
label(brainmind.oneobs$frailty.cat.12) <- "CFS Category, 12m"
label(brainmind.oneobs$study) <- "Study"
label(brainmind.oneobs$site) <- "Site"

describe_vars <- c(
  "study", "site", "age.enroll", "sex.pp", "frailty", "charlson.score",
  "iqcode.score.e", "faq.e", "adl.e", "num.apache", "mean.sofa.icu",
  "ever.vent.s", "vent.los.tot.s.eo", "ever.sevseptic.s",
  "icudays.sevseptic.eo", "ever.del.s", "del.s.imp.eo", "ever.coma.s",
  "coma.s.imp.eo", "icu.los.tot.s", "hosp.los.s"
)

describe_all <- summaryM(
  as.formula(paste(paste(describe_vars, collapse = " + "), "~ 1")),
  data = subset(brainmind.oneobs, id %in% pts_fu)
)

describe_3m <- summaryM(
  as.formula(paste(
    paste(c(describe_vars, "frailty.fu.3"), collapse = " + "),
    "~ frailty.cat.3"
  )),
  data = subset(brainmind.oneobs, id %in% pts_3m & !is.na(frailty.fu.3))
)

describe_12m <- summaryM(
  as.formula(paste(
    paste(c(describe_vars, "frailty.fu.12"), collapse = " + "),
    "~ frailty.cat.12"
  )),
  data = subset(brainmind.oneobs, id %in% pts_12m & !is.na(frailty.fu.12))
)

```

## `r table_nums("describe_all")`

```{r print_describe_all}
html(
  describe_all, digits = 2, what = "%", long = TRUE, prmsd = TRUE, brmsd = TRUE
)

```

## `r table_nums("describe_3m")`

```{r print_describe_3m}
html(
  describe_3m, digits = 2, what = "%", long = TRUE, prmsd = TRUE, brmsd = TRUE
)

```

## `r table_nums("describe_12m")`

```{r print_describe_12m}
html(
  describe_12m, digits = 2, what = "%", long = TRUE, prmsd = TRUE, brmsd = TRUE
)

```

# Description of Clinical Frailty Scores

```{r boxplot_prep}
## -- Need one row per patient per time point, with age category included ------
fu_plotdf <- brainmind.fu %>%
  filter(fu.period %in% paste(c(3, 12), "Month")) %>%
  dplyr::select(id, fu.period, frailty_num) %>%
  mutate(timept = factor(ifelse(fu.period == "3 Month", 1, 2),
                         levels = 1:2, labels = c("3 Months", "12 Months"))) %>%
  left_join(dplyr::select(brainmind.oneobs, id, age.cat), by = "id")

## -- Add frailty at baseline --------------------------------------------------
all_plotdf <- brainmind.oneobs %>%
  dplyr::select(id, frailty_num, age.cat) %>%
  mutate(fu.period = "Enrollment") %>%
  bind_rows(fu_plotdf %>% dplyr::select(-timept)) %>%
  mutate(
    timept = factor(
      ifelse(fu.period == "Enrollment", 1,
      ifelse(fu.period == "3 Month", 2, 3)),
      levels = 1:3, labels = c("Enrollment", "3 Months", "12 Months")
    )
  )

## Data prep for barchart: show % at each number
all_plotdf_bar <- all_plotdf %>%
  filter(!is.na(frailty_num)) %>%
  group_by(timept, frailty_num) %>%
  summarise(frailty_count = n()) %>%
  ungroup() %>%
  left_join(all_plotdf %>%
              filter(!is.na(frailty_num)) %>%
              group_by(timept) %>%
              summarise(total_count = n()),
            by = "timept") %>%
  mutate(frailty_prop = frailty_count / total_count)

## -- Create plots -------------------------------------------------------------
## All frailty combined over time
frailty_time <- ggplot(data = all_plotdf, aes(x = timept, y = frailty_num)) +
  geom_point(colour = "#003D79", alpha = 0.15,
             position = position_jitter(width = 0.25, height = 0.2)) +
  geom_boxplot(colour = "#002346", fill = NA) +
  scale_y_continuous(name = "CSHA Clinical Frailty Score", breaks = 1:7) +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "grey80", fill = NA),
        axis.text.x = element_text(face = "bold")) +
  labs(x = NULL)

pdf("frailty_time.pdf", width = 8, height = 6)
frailty_time
dev.off()

frailty_hist <- ggplot(data = all_plotdf_bar,
                       aes(x = frailty_num, y = frailty_prop, fill = timept)) +
  facet_wrap(~ timept, ncol = 1) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_continuous(breaks = 1:7, name = "CSHA Clinical Frailty Score") +
  scale_y_continuous(name = "Percent of Patients",
                     breaks = seq(0, 1, 0.1),
                     labels = paste0(seq(0, 1, 0.1)*100, "%")) +
  scale_fill_manual(values = c("#003D79", "#48005A", "#598600")) +
  theme_minimal() +
  theme(strip.background = element_rect(fill = "grey90", colour = "grey80"),
        strip.text = element_text(face = "bold"),
        legend.position = "none")

pdf("frailty_hist.pdf", width = 6, height = 8)
frailty_hist
dev.off()

## Frailty at followup by age at enrollment
frailty_age <- ggplot(data = fu_plotdf, aes(x = age.cat, y = frailty_num)) +
  facet_wrap(~ timept, nrow = 1) +
  geom_point(colour = "#003D79", alpha = 0.15,
             position = position_jitter(width = 0.25, height = 0.2)) +
  geom_boxplot(colour = "#002346", fill = NA) +
  scale_x_discrete(name = "Age at Enrollment") +
  scale_y_continuous(name = "CSHA Clinical Frailty Score", breaks = 1:7) +
  theme_minimal() +
  theme(strip.background = element_rect(fill = "grey90", colour = "grey80"),
        strip.text = element_text(face = "bold"),
        panel.border = element_rect(colour = "grey80", fill = NA))

pdf("frailty_age.pdf", width = 8, height = 6)
frailty_age
dev.off()

```

## CFS Over Time

`r figure_nums("boxplots_time", display = "cite")` shows raw CFS scores at ICU
admission, three and twelve months after hospital discharge.

```{r frailty_time, fig.height = 7, fig.width = 6}
frailty_hist

```

## CFS by Age at BRAIN-ICU Enrollment

`r figure_nums("boxplots_age", display = "cite")` shows raw CFS scores at three
and twelve months after hospital discharge by patients' age at BRAIN-ICU
admission. Boxplots are overlaid to summarize the data: the middle bar
represents the median for each age group; the bottom and top bars represent the
25th and 75th percentiles, respectively. In other words, the middle half of the
data is represented by the box.

```{r frailty_age}
frailty_age

```

# Risk Factors for Frailty after Critical Illness

Among ICU survivors with at least partial cognitive and functional assessment
data available at each followup point, we assessed the following covariates for
their potential to be risk factors for increased frailty after critical illness:

Patient characteristics at baseline:

- Age at enrollment
- Years of education
- Sex
- Comorbidities, measured via Charlson score
- Baseline independence, measured via Katz Activities of Daily Living score
- Baseline disability, measured via Functional Activities Questionnaire
- Baseline frailty, measured via CSHA Clinical Frailty Score

Characteristics of critical illness:

- Severity of illness during the ICU stay, measured via mean modified SOFA (ignoring GCS) in the ICU
- Delirium duration
- Coma duration 
- Sepsis duration
- Duration of MV *(for posterity: we went back and forth on ICU LOS vs this)*
- Discharge location (home vs elsewhere)

```{r model_prep}
## -- Sparklines to show distribution of CFS -----------------------------------
cfs_dist_3m <- brainmind.fu %>%
  filter(fu.period == "3 Month" & !is.na(frailty_num)) %>%
  group_by(frailty_num) %>%
  summarise(count = n())

spark_cfs_3m <- sparkline(
  cfs_dist_3m$count,
  type = 'bar',
  barColor = "#003D79",
  elementId = "sparkline-3m",
  width = 35
)

cfs_dist_12m <- brainmind.fu %>%
  filter(fu.period == "12 Month" & !is.na(frailty_num)) %>%
  group_by(frailty_num) %>%
  summarise(count = n())

spark_cfs_12m <- sparkline(
  cfs_dist_12m$count,
  type = 'bar',
  barColor = "#003D79",
  elementId = "sparkline-12m",
  width = 35
)

## -- Data sets for modeling ---------------------------------------------------
## Vector of model covariates
model_covars <- c("age.enroll", "edu", "sex.pp", "charlson.score", "adl.e",
                  "faq.e", "mean.modsofa.icu", "del.s.imp", "coma.s.imp",
                  "icudays.sevseptic.s", "vent.los.all.s", "hospdis.home",
                  "frailty_num")
## For plot titles (to come), set shorter labels for each element of model_covars
model_covar_labels <- c("Age", "Years of Education", "Sex", "Charlson",
                        "Baseline Katz ADL", "FAQ", "Mean Modified SOFA",
                        "Days delirium", "Days coma", "Days severe sepsis",
                        "Days MV", "Discharge location", "Baseline CFS")
names(model_covar_labels) <- model_covars

## Vector of additional variables used for imputation
imp_vars <- c("apache.aps", "icu.los.tot.s", "mean.benz.icu", "mean.op.new.icu",
              "mean.prop.icu")

## Datasets for models at both time points
cfs_df_3m <- brainmind.oneobs %>%
  filter(id %in% pts_3m) %>%
  dplyr::select(
    id, study, site,
    one_of(model_covars), one_of(imp_vars), starts_with("frailty_num")
  )

cfs_df_12m <- brainmind.oneobs %>%
  filter(id %in% pts_12m) %>%
  dplyr::select(
    id, study, site,
    one_of(model_covars), one_of(imp_vars), starts_with("frailty_num")
  )

## -- String manipulation for imputation, model formulas -----------------------
## Which variables should *not* be modeled using splines?
## - imp_ = variables which will be wrapped in I() for imputation; all other
##          continuous variables will automatically be modeled with splines
## - model_ = variables which will *not* get rcs()'d in model formula; includes
##            categoricals
imp_lin_vars <- c("frailty_num.3", "frailty_num.12",
                  "iqcode.score.e", "adl.e", "faq.e", "edu")
model_lin_vars <- c("hospdis.home", "sex.pp", imp_lin_vars)

## -- Create formulas for imputation, models -----------------------------------
## Imputation
I_replace_regex <- paste0(
  "(",
  paste(
    paste0("^", str_replace_all(imp_lin_vars, fixed("."), fixed("\\.")), "$"),
    collapse = "|"
  ),
  ")"
)

## Create formula for imputation (same at both time points, except frailty)
areg_form <- c(model_covars, # imp_vars,
               "frailty_num.3", "frailty_num.12") %>%
  str_replace(I_replace_regex, "I\\(\\1)") %>%
  paste(collapse = " + ") %>%
  paste("~", .)

areg_form_3m <- areg_form %>%
  str_replace(fixed("+ I(frailty_num.12)"), "") %>%
  as.formula

areg_form_12m <- areg_form %>%
  str_replace(fixed("+ I(frailty_num.3)"), "") %>%
  as.formula

## Model right-hand sides (same for both time points)
rcs_replace_regex <- paste0(
  "(",
  paste(
    paste0("^",
           str_replace_all(
             setdiff(model_covars, model_lin_vars),
             fixed("."),
             fixed("\\.")
           ),
           "$"),
    collapse = "|"
  ),
  ")"
)

mod_rhs <- paste(
  str_replace(model_covars, rcs_replace_regex, "rcs\\(\\1, 3\\)"),
  collapse = " + "
)

```

## Modeling Strategy

CFS scores are integers with a narrow range, yet are normally distributed at
each time point (3m: `r spark_cfs_3m`; 12m: `r spark_cfs_12m`). We will use
separate linear regression models at each time point to assess the relationships
between covariates and frailty. Continuous covariates with sufficient
variability will be allowed to have a nonlinear relationship with the outcome
via restricted cubic splines with three knots; this includes age, Charlson, mean
modified SOFA, and durations of coma, delirium, MV, and sepsis. There is not
sufficient variability in education or Katz ADL and FAQ scores to allow splines;
therefore, these covariates are forced to have a linear association with frailty.

Loss to follow-up, due to either death or loss of contact, is a potential source
of bias for these long-term outcomes. Therefore, we will model frailty at 3 and
12 months after discharge in two ways:

1. **Straightforward analysis of patients with outcomes at each time point**,
using separate linear regression models for 3- and 12-month frailty
1. **Models weighted by the inverse probability of attrition**, in which
patients who represent a more "unusual" patient in our follow-up cohort are
weighted more heavily to account for the potential bias in strategy #1. As one
possible scenario, patients who are admitted with higher severity of illness and
more frailty *may* be more likely to die during their ICU stay; in that case,
those patients who come in with high SOI and comorbidities, but do survive and
are able to be assessed at long-term follow-up, are weighted more heavily in the
analysis. More details on weight calculation will be described below.

    *Reference for this approach*: Robins JM, Hernan MA, Brumback B. "Marginal
    structural models and causal inference in epidemiology." *Epidemiology*,
    2000 Sep; 11(5): 550-60. [Pubmed link](https://www.ncbi.nlm.nih.gov/pubmed/10955408).

### Handling Missingness

In both sets of models, if >5% of data for any *covariate* is missing, we
planned to use multiple imputation to reduce bias from missing covariates
(specifically, predictive mean matching with 25 imputations, via the
`Hmisc::aregImpute()` and `Hmisc::fit.mult.impute()` functions. However, given
the extremely low rate of missingness in our covariates among patients with
frailty outcome data, we will use complete case analysis without worry about
bias.

```{r model_missingness, fig.width = 7, fig.height = 5}
missing_df <- bind_rows(cfs_df_3m %>% mutate(fu_period = 1),
                          cfs_df_12m %>% mutate(fu_period = 2)) %>%
  mutate(
    fu_period = factor(fu_period, levels = 1:2, labels = c("3 Months", "12 Months")),
    frailty_outcome = ifelse(fu_period == "3 Months", frailty_num.3, frailty_num.12)
  )

missing_plot <- missing_df %>%
  dplyr::select(one_of(model_covars), frailty_outcome, fu_period) %>%
  naniar::gg_miss_var(show_pct = TRUE, facet = fu_period) +
  theme_bw() +
  theme(strip.text = element_text(hjust = 0, face = "bold")) +
  labs(y = "Percent Missing", title = "% Covariate Missingness")

missing_plot

```

### Inverse Probability Weighting

A brief outline of the steps for inverse probability of attrition weighting
(IPAW):

1. For all `r n_eval` patients in the eligible cohort, model the outcome of
having frailty outcome data at 3 and 12 months after discharge using a logistic
regression model and baseline/in-hospital covariates; using these models,
calculate predicted probabilities for each time point and all patients.
1. Calculate a weight for each patient by taking the inverse of this probability.
1. Examine weights among patients who actually *do* have frailty outcomes at
each time point. The sum should be equivalent to the total `r n_eval` patients.
If we have any extremely high weights, we will truncate weights to help with
model stability.
1. Fit a model equivalent to the unweighted model in all ways, but weighted by
these inverse probability weights.

We use the following baseline and in-hospital covariates to model P(in cohort):

- At enrollment:
    - Age
    - Years of education
    - Sex
    - Charlson comorbidities index
    - Katz ADL and Functional Activities Questionnaire scores at enrollment
    - IQCODE at enrollment
    - Clinical Frailty Score at enrollment
- In-hospital:
    - Mean daily modified SOFA score (GCS component removed)
    - Days of delirium and coma
    - Days of severe sepsis
    - Days on mechanical ventilation
    - Mean daily doses of benzodiazepines, opioids, and propofol while in the ICU

```{r ipw}
## -- 1. Create indicators for whether patient in 3, 12m cohort ----------------
brainmind.oneobs <- brainmind.oneobs %>%
  mutate(
    cohort_3m = id %in% pts_3m,
    cohort_12m = id %in% pts_12m
  )

## -- 2. Setup for IPW models --------------------------------------------------
## Model righthand side (same for both time points)
ipw_rhs <- "rcs(age.enroll, 3) + edu + sex.pp + rcs(charlson.score, 3) + adl.e + faq.e + iqcode.score.e + rcs(frailty_num, 3) + rcs(mean.modsofa.icu, 3) + rcs(del.s.imp, 3) + rcs(coma.s.imp, 3) + rcs(icudays.sevseptic.s, 3) + rcs(vent.los.all.s, 3) + rcs(mean.benz.icu, 3) + rcs(mean.op.icu, 3) + rcs(mean.prop.icu, 3)"

## Function for fitting model and extracting probabilities
prob_cohort <- function(
  cohort_var,
  df = brainmind.oneobs,
  mod_rhs = ipw_rhs
){
  ## Final model formula
  model_formula <- as.formula(
    paste(cohort_var, mod_rhs, sep = " ~ ")
  )
  
  ## Fit model
  prob_mod <- lrm(model_formula, data = df)
  
  ## Extract predicted probabilities for each patient, take inverse
  probs <- predict(prob_mod, type = "fitted")
  wts <- 1 / probs
  
  return(list("mod" = prob_mod, "probs" = probs, "wts" = wts))
}

probwts_3 <- prob_cohort(cohort_var = "cohort_3m")
probwts_12 <- prob_cohort(cohort_var = "cohort_12m")

## Get weights for each time point
brainmind.oneobs$prob_3m <- probwts_3$probs
brainmind.oneobs$prob_12m <- probwts_12$probs
brainmind.oneobs$wt_3m <- probwts_3$wts
brainmind.oneobs$wt_12m <- probwts_12$wts

## Plot, summarize weights for patients in each cohort at each time point
wts_df <- brainmind.oneobs %>%
  dplyr::select(
    id, starts_with("cohort"), starts_with("prob"), starts_with("wt")
  ) %>%
  gather(key = tmpkey, value = tmpval, -id) %>%
  separate(tmpkey, into = c("tmpkey", "timept")) %>%
  spread(key = tmpkey, value = tmpval) %>%
  filter(cohort == 1) %>%
  mutate(timept = forcats::fct_relevel(timept, "3m", "12m"))

# ## Summarize to check
# map(levels(wts_df$timept), ~ summary(subset(wts_df, timept == .)$prob))
# map(levels(wts_df$timept), ~ summary(subset(wts_df, timept == .)$wt))

wts_hist <- ggplot(data = wts_df, aes(x = wt)) +
  facet_wrap(~ timept) +
  geom_histogram() +
  labs(x = "Inverse Probability Weights, Untruncated",
       y = "Count")

wts_summary <- wts_df %>%
  group_by(timept) %>%
  summarise(sumwts = sum(wt, na.rm = TRUE),
            maxwt = max(wt, na.rm = TRUE))

```

We have `r sum(!is.na(brainmind.oneobs$wt_3m))` patients with no missingness
in the variables used to fit the IPAW models; our weights sum to
`r wts_summary %>% filter(timept == "3m") %>% pull(sumwts) %>% round(2)` at 3
months, with a maximum of
`r wts_summary %>% filter(timept == "3m") %>% pull(maxwt) %>% round(2)`, and
`r wts_summary %>% filter(timept == "12m") %>% pull(sumwts) %>% round(2)` at 12
months, with a maximum of
`r wts_summary %>% filter(timept == "12m") %>% pull(maxwt) %>% round(2)`. Full
histograms of the weights are shown below.

```{r wt_plots}
wts_hist

```

```{r model_fit}
## -- Add weights to time-specific data.frames and fit models ------------------
cfs_df_3m <-
  left_join(cfs_df_3m, dplyr::select(brainmind.oneobs, id, wt_3m), by = "id")
cfs_df_12m <-
  left_join(cfs_df_12m, dplyr::select(brainmind.oneobs, id, wt_12m), by = "id")

cfs_mod_3m_unwtd <- ols(
  as.formula(paste("frailty_num.3 ~", mod_rhs)),
  data = cfs_df_3m,
  x = TRUE, y = TRUE
) %>%
  robcov()

cfs_mod_3m_wtd <- ols(
  as.formula(paste("frailty_num.3 ~", mod_rhs)),
  data = cfs_df_3m,
  weights = wt_3m,
  x = TRUE, y = TRUE
) %>%
  robcov()

cfs_mod_12m_unwtd <- ols(
  as.formula(paste("frailty_num.12 ~", mod_rhs)),
  data = cfs_df_12m,
  x = TRUE, y = TRUE
) %>%
  robcov()

cfs_mod_12m_wtd <- ols(
  as.formula(paste("frailty_num.12 ~", mod_rhs)),
  data = cfs_df_12m,
  weights = wt_12m,
  x = TRUE, y = TRUE
) %>%
  robcov()

```

## Model Assumptions

We graphically verified assumptions for linear regression at both time points,
and they are met satisfactorily. While there does appear to be some patterning
in residuals, we believe this is due primarily to the integral nature of our
outcome, as well as low sample size at the worst levels of frailty among ICU
survivors. Residual vs fitted and Q-Q plots are shown in the Details section
below.

<details>

```{r model_assume}
par(mfrow = c(2, 2))
## 3 months
lm_diagnostics(
  cfs_mod_3m_unwtd, outcomeString = "CFS, 3m", titleString = "3m, Unweighted"
)
lm_diagnostics(
  cfs_mod_3m_wtd, outcomeString = "CFS, 3m", titleString = "3m, Weighted"
)

## 12 months
lm_diagnostics(
  cfs_mod_12m_unwtd, outcomeString = "CFS, 12m", titleString = "12m, Unweighted"
)
lm_diagnostics(
  cfs_mod_12m_wtd, outcomeString = "CFS, 12m", titleString = "12m, Weighted"
)

par(mfrow = c(1, 1))

```

</details>

## Model Results

The CSHA Clinical Frailty Score goes from 1 = best to 7 = worst. Therefore,
adjusted differences > 0 are *bad* (higher, worse frailty scores); adjusted
differences < 0 are *good* (lower, better frailty scores).

**Overview:** After adjusting for all covariates, worse dependence and frailty
and a *lower* modified mean SOFA score in the ICU are associated with worse
frailty at both 3 and 12 months after discharge among ICU survivors.
In addition, more comorbidities, discharge to a facility and less education are
associated with worse frailty at 3 months, but not at 12 months; whether this is
due to a true easing of effect or dropout of the most frail patients is a matter
for further consideration. When weighting by inverse probabilities of follow-up,
the association between education and 3m frailty weakened a bit, indicating that
its weakening effect is perhaps due at least in part to dropout. Among those who
survived and were assessed at 12 months, older age is an additional risk factor
for worse frailty at that time point.

Generally speaking, results were qualitatively similar in the weighted vs
unweighted analyses.

(The association between worse severity of illness in the ICU and a *better*
frailty score at followup is surprising; we've had similar conversations about
associations with sepsis in other studies. There may be something about patients
who survive the worst illnesses which allows them to be more resilient after
critical illness.)

```{r model_results}
## Set datadist
dd <- datadist(subset(brainmind.oneobs, id %in% pts_fu)[, names(cfs_df_3m)])
options(datadist = "dd")

## -- Create results tables for each model -------------------------------------
cfs_results_3m_unwtd <- cfs_mod_3m_unwtd %>%
  rms_model_results(labeldf = brainmind.oneobs, rndDigits = 2)
cfs_results_3m_wtd <- cfs_mod_3m_wtd %>%
  rms_model_results(labeldf = brainmind.oneobs, rndDigits = 2)
cfs_results_12m_unwtd <- cfs_mod_12m_unwtd %>%
  rms_model_results(labeldf = brainmind.oneobs, rndDigits = 2)
cfs_results_12m_wtd <- cfs_mod_12m_wtd %>%
  rms_model_results(labeldf = brainmind.oneobs, rndDigits = 2)

## -- Dataset for plotting -----------------------------------------------------
cfs_model_plotdata <- bind_rows(
  cfs_results_3m_unwtd %>% mutate(wtd = 0, timept = 0),
  cfs_results_3m_wtd %>% mutate(wtd = 1, timept = 0),
  cfs_results_12m_unwtd %>% mutate(wtd = 0, timept = 1),
  cfs_results_12m_wtd %>% mutate(wtd = 1, timept = 1)
) %>%
  filter(
    !(label %in% c("All Nonlinear Terms", "Overall Model", "Error", "",
                   "Model L.R.", "R2", "n"))
  ) %>%
  mutate(
    ## Indicator for weighted vs unweighted analyses
    wtd = factor(
      wtd,
      levels = 0:1,
      labels = c("Unweighted", "Inverse Probability Weighted")
    ),
    ## Indicator for time point
    timept = factor(timept, levels = 0:1, labels = c("3 Months", "12 Months")),
    
    ## Eventual Y axis labels: Variable label + comparison points
    low = trimws(gsub(".00", "", gsub("0$", "", low), fixed = TRUE)),
    high = trimws(gsub(".00", "", gsub("0$", "", high), fixed = TRUE)),
    ## Shorten variable labels
    label = case_when(
      label == "Katz ADL score at enrollment" ~
        sprintf("Baseline Katz ADL\n%s vs %s", high, low),
      label == "Age at study enrollment" ~ sprintf("Age\n%s vs %s", high, low),
      label == "Charlson score" ~
        sprintf("Charlson Comorbidities Index\n%s vs %s", high, low),
      label == "Days of coma within study period (imputed)" ~
        sprintf("Days of coma\n%s vs %s", high, low),
      label == "Days of delirium within study period (imputed)" ~
        sprintf("Days of delirium\n%s vs %s", high, low),
      label == "FAQ score at enrollment" ~
        sprintf("Baseline FAQ\n%s vs %s", high, low),
      label == "CSHA CFS at enrollment" ~
        sprintf("Baseline CFS\n%s vs %s", high, low),
      label == "Discharge location (home/other)" ~
        "Discharge location\nFacility vs home",
      label == "Days severely septic in ICU during study period" ~
        sprintf("Days of severe sepsis\n%s vs %s", high, low),
      label == "Mean modified SOFA (no CNS) on ICU days during study period" ~
        sprintf("Mean modified SOFA\n%s vs %s", high, low),
      label == "Days on MV during study period" ~
        sprintf("Days on MV\n%s vs %s", high, low),
      TRUE ~ sprintf("%s\n%s vs %s", label, high, low)
    )
  ) %>%
  ## Separate differences, confidence limits from column est.ci
  separate(
    col = est.ci, into = c("pointest", "lcl", "ucl"), sep = " \\(|, |\\)"
  ) %>%
  mutate_at(vars(pointest, lcl, ucl), as.numeric)

## -- Visualize results of all four models -------------------------------------
cfs_model_plot <- ggplot(
  data = cfs_model_plotdata,
  ## Variables are ordered by their maximum estimated effect size; could be
  ## different for both time points
  aes(x = forcats::fct_reorder(.f = label, .x = pointest, .fun = max),
      y = pointest, group = wtd, colour = wtd, shape = wtd)) +
  facet_wrap(~ timept, nrow = 1) +
  ## Reference line at "no association"
  geom_hline(yintercept = 0, colour = "grey50", alpha = 0.5, size = 1) +
  ## Plot point estimate, CI
  geom_pointrange(
    aes(ymin = lcl, ymax = ucl), position = position_dodge(width = 0.75)
  ) +
  ## geom_pointrange only works with ymin/max; flip it!
  coord_flip() +
  ## Make it pretty
  scale_colour_manual(values = c("#003D79", "#790001")) +
  scale_shape_manual(values = c(15, 16)) +
  theme_minimal() +
  theme(legend.position = "bottom", legend.direction = "horizontal",
        legend.title = element_blank(),
        panel.border = element_rect(fill = NA, colour = "grey50"),
        strip.text = element_text(face = "bold", size = 12)) +
  labs(
    x = "",
    y = "Adjusted Difference in Clinical Frailty Scores (95% CI)"
  )

```

```{r full_results, fig.height = 7, fig.width = 7}
cfs_model_plot

```

### Model Results, 3-Month Frailty{.tabset}

#### Visual Results

<font color = "#003D79">**Blue**</font> = unweighted results; <font color = "#790001">**red**</font> = models using IPAW.

```{r plots_3m, fig.height = 7, fig.width = 7}
cfs_plots_3m <- map(
  model_covars,
  .f = predict_cfs_vals,
  mod_unwtd = "cfs_mod_3m_unwtd",
  mod_wtd = "cfs_mod_3m_wtd",
  varlabels = model_covar_labels
) %>%
  set_names(model_covars)

multiplot(
  plotlist = cfs_plots_3m,
  layout = matrix(c(1:13, rep(NA, 3)), nrow = 4, byrow = TRUE)
)

```

#### Unweighted Model

```{r results_3m_unwtd}
## Vector of column names
cfs_results_colnames <- c(
  "Variable", "Ref Level", "Comparison", "Difference (95% CI)", "X^2^", "df", "P"
)

cfs_results_3m_unwtd %>%
  kable(
    format = "html",
    col.names = cfs_results_colnames,
    row.names = FALSE,
    align = c("l", rep("r", 6))
  ) %>%
  mykablestyle()

```

#### IPAW Model

```{r results_3m_wtd}
cfs_results_3m_wtd %>%
  kable(
    format = "html",
    col.names = cfs_results_colnames,
    row.names = FALSE,
    align = c("l", rep("r", 6))
  ) %>%
  mykablestyle()

```

### Model Results, 12-Month Frailty{.tabset}

#### Visual Results

<font color = "#003D79">**Blue**</font> = unweighted results; <font color = "#790001">**red**</font> = models using IPAW.

```{r plots_12m, fig.height = 7, fig.width = 7}
cfs_plots_12m <- map(
  model_covars,
  .f = predict_cfs_vals,
  mod_unwtd = "cfs_mod_12m_unwtd",
  mod_wtd = "cfs_mod_12m_wtd",
  varlabels = model_covar_labels
) %>%
  set_names(model_covars)

multiplot(
  plotlist = cfs_plots_12m,
  layout = matrix(c(1:13, rep(NA, 3)), nrow = 4, byrow = TRUE)
)

```

#### Unweighted Model

```{r results_12m_unwtd}
cfs_results_12m_unwtd %>%
  kable(
    format = "html",
    col.names = cfs_results_colnames,
    row.names = FALSE,
    align = c("l", rep("r", 6))
  ) %>%
  mykablestyle()

```

#### IPAW Model

```{r results_12m_wtd}
cfs_results_12m_wtd %>%
  kable(
    format = "html",
    col.names = cfs_results_colnames,
    row.names = FALSE,
    align = c("l", rep("r", 6))
  ) %>%
  mykablestyle()

```

```{r abstract_plots}
## -- Create plots for ATS abstract --------------------------------------------
## These won't look exactly like ATS versions due to addition of MINDICU data

## Plots for each time point, unweighted only
cfs_plots_3m_unwtd <- map(
  model_covars,
  .f = predict_cfs_vals,
  mod_unwtd = "cfs_mod_3m_unwtd",
  varlabels = model_covar_labels
)
cfs_plots_12m_unwtd <- map(
  model_covars,
  .f = predict_cfs_vals,
  mod_unwtd = "cfs_mod_12m_unwtd",
  varlabels = model_covar_labels
)

names(cfs_plots_3m_unwtd) <- names(cfs_plots_12m_unwtd) <- model_covars

## Which variables to plot
ats_plotvars <- c("frailty_num", "adl.e", "edu", "mean.modsofa.icu")

## Create a list of all plots that we want (all above variables at 3, 12m)
ats_plotlist <- map2(.x = rep(ats_plotvars, 2),
                     .y = c(rep(list(cfs_plots_3m_unwtd), length(ats_plotvars)),
                            rep(list(cfs_plots_12m_unwtd), length(ats_plotvars))),
                     .f = ~ pluck(.y, .x))

## Title changes: want main title at the top to say 3/12m;
## subtitles = variable for 3m column, blank for 12m column
ats_change_titles <- function(gg, use_sub = c(TRUE, FALSE)){
  tmp <- gg$labels$title
  if(use_sub){
    gg$labels$subtitle <- tmp
  } else{
    gg <- gg +
      labs(subtitle = "") +
      theme(axis.text.y = element_text(color = "white"))
    gg$labels$subtitle <- ""
  }
  gg$labels$title <- ""
  gg
}

ats_plotlist <- map2(.x = ats_plotlist,
                     .y = c(rep(TRUE, length(ats_plotvars)),
                            rep(FALSE, length(ats_plotvars))),
                     .f = ats_change_titles)

## Manually add 3/12m titles
ats_plotlist[[1]] <- ats_plotlist[[1]] +
  scale_x_continuous(breaks = 1:7) +
  labs(title = "3 Months") +
  theme(plot.title = element_text(size = 12),
        plot.subtitle = element_text(size = 9),
        panel.grid.minor.x = element_blank())
ats_plotlist[[5]] <- ats_plotlist[[5]] +
  scale_x_continuous(breaks = 1:7) +
  labs(title = "12 Months") +
  theme(plot.title = element_text(size = 12),
        plot.subtitle = element_text(size = 9),
        panel.grid.minor.x = element_blank())

## Create final PDF
pdf("ats_plots.pdf", height = 7, width = 3.25)
multiplot(
  plotlist = ats_plotlist,
  layout = matrix(1:8, ncol = 2)
)
dev.off()

```


# Trajectory of Frailty over Time

This spaghetti plot was used to explore data in preparation for mixed effects
models and/or latent class analysis. It is left in the report in case it's of
interest.

```{r describe_frailty}
## -- Spaghetti plot for frailty at all three time points ----------------------

## Function: given a dataset, extract frailty variable and patient ID and give
## consistent names; I *know* that the variables I want are named "frailty" and
## "frailty.fu", and that there are no other variables that start with "frailty"
extract_frailty <- function(df, timept){
  dplyr::select(df, id, matches("^frailty[\\.fu]*$")) %>%
    rename(frailty = !!names(.[2])) %>%
    mutate(time = timept)
}

frailty_data <- map2_dfr(
  list(brainmind.oneobs,
       subset(brainmind.fu, fu.period == "3 Month"),
       subset(brainmind.fu, fu.period == "12 Month")
  ),
  c(0, 3, 12),
  extract_frailty
) %>%
  ## Create numeric version of frailty from original character strings
  mutate(frailty_num = as.numeric(str_sub(frailty, 1, 1)))

## Spaghetti plot
ggplot(data = frailty_data, aes(x = time, y = frailty_num)) +
  # geom_smooth(method = "lm") +
    ## doesn't really add anything; straight line across the middle
  geom_line(aes(group = id), alpha = 0.1, colour = "#003D79") +
  theme_minimal() +
  theme(panel.grid = element_blank()) +
  scale_x_continuous(name = "",
                     breaks = c(0, 3, 12),
                     labels = c("Baseline", "3M", "12M")) +
  scale_y_continuous(name = "Clinical Frailty Score", breaks = 1:7)

```

# Software Details

All analyses were performed using `r R.version$version.string`. Individual
package details are noted below.

<details>
```{r session_info, results = "markup"}
devtools::session_info()

```

</details>