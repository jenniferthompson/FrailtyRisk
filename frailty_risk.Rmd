---
title: "Clinical Risk Factors for Long-Term Frailty"
author: "Jennifer Thompson, MPH; Supervisor: Rameela Chandrasekhar, PhD"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_float: yes
    toc_depth: 2
    theme: cosmo
---

Using the BRAIN-ICU cohort, which collected the [CSHA Clinical Frailty Score](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1188185/) (CFS) both prior to ICU admission and at three and twelve months following hospital discharge, we will examine several baseline and in-ICU covariates as potential risk factors for long-term frailty.

```{r setup}
## Set default options
knitr::opts_chunk$set(echo = TRUE, results = "hide", warning = FALSE, message = FALSE)
options(width = 100)

## Load libraries
# suppressPackageStartupMessages(library(huxtable))
suppressPackageStartupMessages(library(rms))
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(stringr))
# suppressPackageStartupMessages(library(forcats))
# suppressPackageStartupMessages(library(naniar))
suppressPackageStartupMessages(library(sparkline))
suppressPackageStartupMessages(library(plotly))
suppressPackageStartupMessages(library(JTHelpers))
suppressPackageStartupMessages(library(captioner))

## Analysis data sets are stored in parent directory (actually two levels above)
load("..//..//braindata.Rdata")

```

```{r tables_figs}
table_nums <- captioner(prefix = "Table")
table_nums(
  name = "describe_all",
  caption = "Description of All Patients with 3 and/or 12m Frailty Data"
)
table_nums(
  name = "describe_3m",
  caption = "Description of Patients with 3m Frailty Data by 3m CFS"
)
table_nums(
  name = "describe_12m",
  caption = "Description of Patients with 12m Frailty Data by 12m CFS"
)

figure_nums <- captioner(prefix = "Figure")
figure_nums(name = "boxplots", caption = "CSHA Frailty Scores by Age at Enrollment")
figure_nums(name = "spaghetti", caption = "CSHA Frailty Scores Over Time")

```

```{r data_prep}
## -- Create age category, dichotomous discharge location variables ------------
brain.oneobs <- brain.oneobs %>%
  mutate(age.cat = factor(ifelse(is.na(age.enroll), NA,
                          ifelse(age.enroll < 50, 1,
                          ifelse(age.enroll < 65, 2, 3))),
                          levels = 1:3,
                          labels = c("<50", "50-64", ">=65")),
         hospdis.home = factor(ifelse(is.na(hospdis.loc), NA,
                               ifelse(hospdis.loc == "Home", 1, 2)),
                               levels = 1:2, labels = c("Home", "Facility")))

## -- Get IDs of those w/ at least partial assessment data at 3 and/or 12m -----
fu_outcomes <- c("rbans.global.score", "rbans.attention.tscore",
                 "rbans.delayedmem.tscore", "rbans.immmemory.tscore",
                 "rbans.language.tscore", "rbans.visuo.tscore",
                 "trail.b.tscore", "trail.a.tscore", "mmse.tscore", "sf36.mcs",
                 "sf36.pcs", "adl.totscore", "faq.totscore", "bdi.totscore",
                 "pcl.totscore", "caps.score", "frailty.fu")

brain.fu$any_fu <- rowSums(!is.na(brain.fu[, fu_outcomes])) > 0

pts_3m <- subset(brain.fu, fu.period == "3 Month" & any_fu)$id
pts_12m <- subset(brain.fu, fu.period == "12 Month" & any_fu)$id
pts_fu <- union(pts_3m, pts_12m)

## -- Create frailty *categories* at 3m, 12m and add to brain.oneobs -----------
brain.fu <- brain.fu %>%
  mutate(
    ## Numeric version of frailty for later use
    frailty_num = as.numeric(str_sub(frailty.fu, 1, 1)),
    frailty.cat = factor(ifelse(is.na(frailty_num), NA,
                         ifelse(frailty_num <= 3, 1,
                         ifelse(frailty_num == 4, 2, 3))),
                         levels = 1:3,
                         labels = c("CFS = 1, 2, 3", "CFS = 4", "CFS = 5, 6, 7"))
  )

fu_frailty <- brain.fu %>%
  dplyr::select(id, fu.period, frailty.fu, frailty_num, frailty.cat) %>%
  filter(fu.period %in% c("3 Month", "12 Month")) %>%
  mutate(fu.period = str_extract(fu.period, "^[0-9]+")) %>%
  gather(key = frailty_var, value = frailty_val, frailty.fu:frailty.cat) %>%
  unite(col = "frailty_var", frailty_var, fu.period, sep = ".") %>%
  spread(key = frailty_var, value = frailty_val) %>%
  mutate(frailty_num.3 = as.numeric(frailty_num.3),
         frailty_num.12 = as.numeric(frailty_num.12))

brain.oneobs <- merge(brain.oneobs, fu_frailty, by = "id", all.x = TRUE)

```

# Description of Cohort

We'll describe the cohort in two ways:

1. Baseline and in-hospital characteristics of any patient with at least some followup assessment data available at 3- and/or 12-month followup (`r table_nums("describe_all", display = "cite")`)
1. Baseline and in-hospital characteristics *and* CFS of any patient with CFS available at a) 3 months and b) 12 months (`r table_nums("describe_3m", display = "cite")` and `r table_nums("describe_12m", display = "cite")`), stratified by CFS at that time point

```{r describe_tables}
label(brain.oneobs$frailty) <- "CSHA Frailty Score at enrollment"
label(brain.oneobs$frailty.fu.3) <- "CSHA Frailty Score, 3m"
label(brain.oneobs$frailty.fu.12) <- "CSHA Frailty Score, 12m"
label(brain.oneobs$frailty.cat.3) <- "CFS Category, 3m"
label(brain.oneobs$frailty.cat.12) <- "CFS Category, 12m"

describe_vars <- c("age.enroll", "sex.pp", "frailty", "charlson.score",
                   "iqcode.score.e", "faq.e", "adl.e", "num.apache",
                   "mean.sofa.icu", "ever.vent.s", "vent.los.tot.s.eo",
                   "ever.sevseptic.s", "icudays.sevseptic.eo", "ever.del.s",
                   "del.s.imp.eo", "ever.coma.s", "coma.s.imp.eo",
                   "icu.los.tot.s", "hosp.los.s")

describe_all <- summaryM(
  as.formula(paste(paste(describe_vars, collapse = " + "), "~ 1")),
  data = subset(brain.oneobs, id %in% pts_fu)
)

describe_3m <- summaryM(
  as.formula(paste(
    paste(c(describe_vars, "frailty.fu.3"), collapse = " + "),
    "~ frailty.cat.3"
  )),
  data = subset(brain.oneobs, id %in% pts_3m & !is.na(frailty.fu.3))
)

describe_12m <- summaryM(
  as.formula(paste(
    paste(c(describe_vars, "frailty.fu.12"), collapse = " + "),
    "~ frailty.cat.12"
  )),
  data = subset(brain.oneobs, id %in% pts_12m & !is.na(frailty.fu.12))
)

```

## `r table_nums("describe_all")`

```{r print_describe_all}
html(
  describe_all, digits = 2, what = "%", long = TRUE, prmsd = TRUE, brmsd = TRUE
)

```

## `r table_nums("describe_3m")`

```{r print_describe_3m}
html(
  describe_3m, digits = 2, what = "%", long = TRUE, prmsd = TRUE, brmsd = TRUE
)

```

## `r table_nums("describe_12m")`

```{r print_describe_12m}
html(
  describe_12m, digits = 2, what = "%", long = TRUE, prmsd = TRUE, brmsd = TRUE
)

```

# Description of Frailty by Age at BRAIN-ICU Enrollment

`r figure_nums("boxplots", display = "cite")` shows raw CFS scores at three and twelve months after hospital discharge by patients' age at BRAIN-ICU admission. Boxplots are overlaid to summarize the data: the middle bar represents the median for each age group; the bottom and top bars represent the 25th and 75th percentiles, respectively. In other words, the middle half of the data is represented by the box.

```{r boxplot_prep}
## -- Need one row per patient per time point, with age category included ------
fu_plotdf <- brain.fu %>%
  filter(fu.period %in% paste(c(3, 12), "Month")) %>%
  dplyr::select(id, fu.period, frailty_num) %>%
  mutate(timept = factor(ifelse(fu.period == "3 Month", 1, 2),
                         levels = 1:2, labels = c("3 Months", "12 Months"))) %>%
  left_join(dplyr::select(brain.oneobs, id, age.cat), by = "id")

ggplot(data = fu_plotdf, aes(x = age.cat, y = frailty_num)) +
  facet_wrap(~ timept, nrow = 1) +
  geom_point(colour = "#003D79", alpha = 0.15,
             position = position_jitter(width = 0.25, height = 0.2)) +
  geom_boxplot(colour = "#002346", fill = NA) +
  scale_x_discrete(name = "Age at Enrollment") +
  scale_y_continuous(name = "CSHA Clinical Frailty Score", breaks = 1:7) +
  theme_minimal() +
  theme(strip.background = element_rect(fill = "grey90"),
        strip.text = element_text(face = "bold"),
        panel.border = element_rect(colour = "grey80", fill = NA))

```

# Risk Factors for Frailty after Critical Illness

Among ICU survivors with at least partial cognitive and functional assessment data available at each followup point, we assessed the following covariates for their potential to be risk factors for increased frailty after critical illness:

Patient characteristics at baseline:

- Age at enrollment
- Years of education
- Sex
- Comorbidities, measured via Charlson score
- Baseline independence, measured via Katz Activities of Daily Living score
- Baseline disability, measured via Functional Activities Questionnaire

Characteristics of critical illness:

- Severity of illness during the ICU stay, measured via mean modified SOFA (ignoring GCS) in the ICU
- Delirium duration
- Coma duration 
- Sepsis duration
- Duration of MV *(for posterity: we went back and forth on ICU LOS vs this)*
- Discharge location (home vs elsewhere)

```{r model_prep}
## -- Sparklines to show distribution of CFS -----------------------------------
cfs_dist_3m <- brain.fu %>%
  filter(fu.period == "3 Month" & !is.na(frailty_num)) %>%
  group_by(frailty_num) %>%
  summarise(count = n())

spark_cfs_3m <- sparkline(
  cfs_dist_3m$count,
  type = 'bar',
  barColor = "#003D74",
  elementId = "sparkline-3m",
  width = 35
)

cfs_dist_12m <- brain.fu %>%
  filter(fu.period == "12 Month" & !is.na(frailty_num)) %>%
  group_by(frailty_num) %>%
  summarise(count = n())

spark_cfs_12m <- sparkline(
  cfs_dist_12m$count,
  type = 'bar',
  barColor = "#003D74",
  elementId = "sparkline-12m",
  width = 35
)

## -- Data sets for modeling ---------------------------------------------------
## Vector of model covariates
model_covars <- c("age.enroll", "edu", "sex.pp", "charlson.score", "adl.e",
                  "faq.e", "mean.modsofa.icu", "del.s.imp", "coma.s.imp",
                  "icudays.sevseptic.s", "vent.los.tot.s", "hospdis.home")
## Vector of additional variables used for imputation
imp_vars <- c("frailty", "apache.aps", "icu.los.tot.s",
              "mean.benz.icu", "mean.op.new.icu", "mean.prop.icu")

## Datasets for models at both time points
cfs_df_3m <- brain.oneobs %>%
  filter(id %in% pts_3m) %>%
  dplyr::select(
    id, one_of(model_covars), one_of(imp_vars), starts_with("frailty_num")
  ) %>%
  mutate(frailty = as.numeric(str_sub(frailty, 1, 1)))

cfs_df_12m <- brain.oneobs %>%
  filter(id %in% pts_12m) %>%
  dplyr::select(
    id, one_of(model_covars), one_of(imp_vars), starts_with("frailty_num")
  ) %>%
  mutate(frailty_num = as.numeric(str_sub(frailty, 1, 1)))

## -- String manipulation for imputation, model formulas -----------------------
## Which variables should *not* be modeled using splines?
## - imp_ = variables which will be wrapped in I() for imputation; all other
##          continuous variables will automatically be modeled with splines
## - model_ = variables which will *not* get rcs()'d in model formula; includes
##            categoricals
imp_lin_vars <- c("frailty", "frailty_num.3", "frailty_num.12",
                  "iqcode.score.e", "adl.e", "faq.e", "edu")
model_lin_vars <- c("hospdis.home", "sex.pp", imp_lin_vars)

## -- Create formulas for imputation, models -----------------------------------
## Imputation
I_replace_regex <- paste0(
  "(",
  paste(
    paste0("^", str_replace_all(imp_lin_vars, fixed("."), fixed("\\.")), "$"),
    collapse = "|"
  ),
  ")"
)

## Create formula for imputation (same at both time points, except frailty)
areg_form <- c(model_covars, # imp_vars,
               "frailty_num.3", "frailty_num.12") %>%
  str_replace(I_replace_regex, "I\\(\\1)") %>%
  paste(collapse = " + ") %>%
  paste("~", .)

areg_form_3m <- areg_form %>%
  str_replace(fixed("+ I(frailty_num.12)"), "") %>%
  as.formula

areg_form_12m <- areg_form %>%
  str_replace(fixed("+ I(frailty_num.3)"), "") %>%
  as.formula

## Model right-hand sides (same for both time points)
rcs_replace_regex <- paste0(
  "(",
  paste(
    paste0("^",
           str_replace_all(
             setdiff(model_covars, model_lin_vars),
             fixed("."),
             fixed("\\.")
           ),
           "$"),
    collapse = "|"
  ),
  ")"
)

mod_rhs <- paste(
  str_replace(model_covars, rcs_replace_regex, "rcs\\(\\1, 3\\)"),
  collapse = " + "
)

```

## Modeling Strategy

CFS scores are integers with a narrow range, yet are normally distributed at each time point (3m: `r spark_cfs_3m`; 12m: `r spark_cfs_12m`). We will use separate linear regression models at each time point to assess the relationships between covariates and frailty. All continuous covariates will be allowed to have a nonlinear relationship with the outcome via restricted cubic splines with three knots.

Because patients with complete data are likely different from patients who survived critical illness but were unable to complete the followup assessment, we will use multiple imputation to account for missing data and reduce the likelihood of bias due to these differences. Specifically, we'll use predictive mean matching with 10 imputations, via the `Hmisc::aregImpute()` and `Hmisc::fit.mult.impute()` functions.

```{r model_impute}
## -- We'll use the same formula for imputing at 3m, 12m -----------------------
set.seed(56)
areg_3m <- aregImpute(areg_form_3m, data = cfs_df_3m, n.impute = 10, nk = 0)
areg_12m <- aregImpute(areg_form_12m, data = cfs_df_12m, n.impute = 10, nk = 0)

```

```{r model_fit}
cfs_mod_3m <- fit.mult.impute(
  as.formula(paste("frailty_num.3 ~", mod_rhs)),
  fitter = ols,
  xtrans = areg_3m,
  data = cfs_df_3m
)

cfs_mod_12m <- fit.mult.impute(
  as.formula(paste("frailty_num.12 ~", mod_rhs)),
  fitter = ols,
  xtrans = areg_12m,
  data = cfs_df_12m
)

```

## Model Assumptions

```{r model_assume}
lm_diagnostics(cfs_mod_3m, outcomeString = "CFS, 3m", titleString = "3m Frailty")
lm_diagnostics(cfs_mod_12m, outcomeString = "CFS, 12m", titleString = "12m Frailty")

```

## Model Results

# Trajectory of Frailty over Time

This spaghetti plot was used to explore data in preparation for mixed effects models and/or latent class analysis. It is left in the report in case it's of interest.

```{r describe_frailty}
## -- Spaghetti plot for frailty at all three time points ----------------------

## Function: given a dataset, extract frailty variable and patient ID and give
## consistent names; I *know* that the variables I want are named "frailty" and
## "frailty.fu", and that there are no other variables that start with "frailty"
extract_frailty <- function(df, timept){
  dplyr::select(df, id, matches("^frailty[\\.fu]*$")) %>%
    rename(frailty = !!names(.[2])) %>%
    mutate(time = timept)
}

frailty_data <- map2_dfr(
  list(brain.oneobs,
       subset(brain.fu, fu.period == "3 Month"),
       subset(brain.fu, fu.period == "12 Month")
  ),
  c(0, 3, 12),
  extract_frailty
) %>%
  ## Create numeric version of frailty from original character strings
  mutate(frailty_num = as.numeric(str_sub(frailty, 1, 1)))

## Spaghetti plot
ggplot(data = frailty_data, aes(x = time, y = frailty_num)) +
  # geom_smooth(method = "lm") +
    ## doesn't really add anything; straight line across the middle
  geom_line(aes(group = id), alpha = 0.1, colour = "#003D79") +
  theme_minimal() +
  theme(panel.grid = element_blank()) +
  scale_x_continuous(name = "",
                     breaks = c(0, 3, 12),
                     labels = c("Baseline", "3M", "12M")) +
  scale_y_continuous(name = "Clinical Frailty Score", breaks = 1:7)

```

# Software Details

All analyses were performed using `r R.version$version.string`. Individual package details are noted below.

<details>
```{r session_info, results = "markup"}
devtools::session_info()

```

</details>